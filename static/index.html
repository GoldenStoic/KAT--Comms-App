<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice+Chat Room</title>
  <style>
    body { font-family: sans-serif; }
    #waiting, #chat, #controls, #material { margin: 1em; }
    audio { display: block; margin: 0.5em 0; }
  </style>
</head>
<body>
  <h1>Training Room</h1>

  <div id="waiting">Waiting for admin to admitâ€¦</div>

  <div id="controls" style="display:none;">
    <button id="admitBtn">(Admin) Admit Selected</button>
    <select id="waitingList"></select>
    <br/><br/>
    <button id="nextSlide">Next Slide</button>
    <button id="startQuiz">Start Quiz</button>
  </div>

  <div id="material"></div>

  <div id="chat" style="display:none;">
    <div id="chatLog" style="height:200px; overflow:auto; border:1px solid #ccc;"></div>
    <input id="msgIn" placeholder="Messageâ€¦"/><button id="sendBtn">Send</button>
  </div>

  <script>
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 1) Setup WS & ICE config
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const token  = prompt("Enter token (admin or user JWT)");
    const roomId = "room123";
    const proto  = location.protocol === "https:" ? "wss" : "ws";
    const wsUrl  = `${proto}://${location.host}/ws/${roomId}?token=${encodeURIComponent(token)}`;
    console.log("Connecting to", wsUrl);
    const ws     = new WebSocket(wsUrl);

    const ICE_SERVERS = [
      { urls: [ "stun:stun.l.google.com:19302" ] },
      { urls: [ "stun:global.stun.twilio.com:3478" ] }
    ];

    let pc, localStream;

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 2) Handle incoming WS messages
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    ws.onopen = () => console.log("WebSocket opened");
    ws.onerror = e => console.error("WebSocket error", e);
    ws.onclose = () => console.warn("WebSocket closed");

    ws.onmessage = async ({ data }) => {
      let msg;
      try { msg = JSON.parse(data); }
      catch { console.error("Invalid WS message:", data); return; }

      console.log("WS â†", msg);
      switch (msg.type) {
        case "new_waiting":
          const sel = document.getElementById("waitingList");
          const opt = document.createElement("option");
          opt.value = msg.peer_id;
          opt.text  = `User ${msg.peer_id}`;
          sel.appendChild(opt);
          break;

        case "waiting":
          document.getElementById("waiting").style.display = "block";
          break;

        case "admitted":
        case "ready_for_offer":
          document.getElementById("waiting").style.display  = "none";
          document.getElementById("chat").style.display     = "block";
          document.getElementById("controls").style.display = tokenRole() === "admin" ? "block" : "none";
          await startWebRTC();
          break;

        case "answer":
          console.log("â† answer SDP");
          await pc.setRemoteDescription(new RTCSessionDescription({ type:"answer", sdp: msg.sdp }));
          break;

        case "ice":
          console.log("â† remote ICE candidate", msg.candidate);
          if (pc && msg.candidate) {
            try {
              await pc.addIceCandidate(msg.candidate);
              console.log("âœ” added ICE candidate");
            } catch(e) {
              console.error("âœ– failed to add ICE candidate:", e);
            }
          }
          break;

        case "chat":
          document.getElementById("chat").style.display = "block";
          const log = document.getElementById("chatLog");
          log.innerHTML += `<div><b>${msg.from}:</b> ${msg.text}</div>`;
          log.scrollTop = log.scrollHeight;
          break;

        case "material_event":
          handleMaterial(msg.event, msg.payload);
          break;
      }
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 3) WebRTC setup & negotiation
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function startWebRTC() {
      if (pc) return;  // only once

      // 3.1) request mic
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("Got local audio:", localStream.getTracks());
      } catch(err) {
        alert("Microphone access is required: " + err.message);
        return;
      }

      // 3.2) create peer
      pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

      // debug ICE/connection state
      pc.oniceconnectionstatechange = () => console.log("ICE state â†’", pc.iceConnectionState);
      pc.onconnectionstatechange    = () => console.log("PeerConnection state â†’", pc.connectionState);

      pc.onicecandidate = e => {
        if (e.candidate) {
          console.log("â†’ sending ICE candidate", e.candidate.toJSON());
          ws.send(JSON.stringify({ type: "ice", candidate: e.candidate.toJSON() }));
        }
      };

      pc.ontrack = e => {
        console.log("ğŸµ ontrack", e);
        const audio = document.createElement("audio");
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        audio.controls = true;
        document.body.appendChild(audio);
      };

      // 3.3) attach mic
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // 3.4) create & send offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log("â†’ sending SDP offer");
      ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp }));
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 4) Chat & admin controls
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    document.getElementById("sendBtn").onclick = () => {
      const text = document.getElementById("msgIn").value;
      ws.send(JSON.stringify({ type: "chat", from: tokenRole(), text }));
      document.getElementById("msgIn").value = "";
    };

    document.getElementById("admitBtn").onclick = () => {
      const peerId = Number(document.getElementById("waitingList").value);
      ws.send(JSON.stringify({ type: "admit", peer_id: peerId }));
    };

    document.getElementById("nextSlide").onclick = () => {
      ws.send(JSON.stringify({ type:"material_event", event:"next_slide" }));
    };
    document.getElementById("startQuiz").onclick = () => {
      ws.send(JSON.stringify({ type:"material_event", event:"start_quiz", payload:{ quizId:42 } }));
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Helpers
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function tokenRole() {
      try { return JSON.parse(atob(token.split(".")[1])).role; }
      catch { return "user"; }
    }
    function handleMaterial(event, payload) {
      const mat = document.getElementById("material");
      if (event==="next_slide") mat.innerHTML += "<p>â¡ï¸ Next slide</p>";
      if (event==="start_quiz")  mat.innerHTML += `<p>â“ Quiz ${payload.quizId} started!</p>`;
    }
  </script>
</body>
</html>
