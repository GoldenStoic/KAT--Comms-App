<!-- static/index.html (exactly your full UI + debug hooks) -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice+Chat Room (Debug Mode)</title>
  <style>
    body { font-family: sans-serif; }
    #waiting,#chat,#controls,#material { margin:1em }
    #stats { font-family:monospace; white-space:pre; background:#f0f0f0; padding:1em }
  </style>
</head>
<body>
  <h1>Training Room (Debug Mode)</h1>

  <div id="waiting">Waiting for admin to admit‚Ä¶</div>

  <div id="controls" style="display:none;">
    <button id="admitBtn">(Admin) Admit Selected</button>
    <select id="waitingList"></select>
    <br/><br/>
    <button id="nextSlide">Next Slide</button>
    <button id="startQuiz">Start Quiz</button>
  </div>

  <div id="material"></div>

  <div id="chat" style="display:none;">
    <div id="chatLog" style="height:200px;overflow:auto;border:1px solid #ccc"></div>
    <input id="msgIn" placeholder="Message‚Ä¶"/><button id="sendBtn">Send</button>
  </div>

  <h2>Connection Stats</h2>
  <div id="stats">No stats yet</div>

  <script>
    const token  = prompt("Enter token (admin/user JWT)"),
          roomId = "room123",
          proto  = location.protocol==="https:"?"wss":"ws",
          ws     = new WebSocket(`${proto}://${location.host}/ws/${roomId}?token=${encodeURIComponent(token)}`);

    let ICE_SERVERS=[], pc, localStream, hasOffered=false;

    async function loadIceServers(){
      console.log("üîç Fetching ICE servers");
      const res=await fetch("/ice");
      ICE_SERVERS=await res.json();
      console.log("‚úÖ ICE_SERVERS:",ICE_SERVERS);
    }

    ws.onopen  =()=>console.log("üîó WS connected");
    ws.onclose =()=>console.log("üîå WS closed");

    ws.onmessage = async ({data})=>{
      console.log("üì© raw ws msg:",data);
      let msg; try{ msg=JSON.parse(data) }catch{ return }
      switch(msg.type){
        case "waiting":
          document.getElementById("waiting").style.display="block"; break;
        case "new_waiting":
          document.getElementById("controls").style.display="block";
          let opt=document.createElement("option");
          opt.value=msg.peer_id; opt.text=`User ${msg.peer_id}`;
          document.getElementById("waitingList").appendChild(opt);
          break;
        case "admitted":
          document.getElementById("waiting").style.display="none";
          document.getElementById("chat").style.display="block";
          document.getElementById("controls").style.display=(tokenRole()==="admin")?"block":"none";
          break;
        case "ready_for_offer":
          console.log("üì® ready_for_offer @",performance.now().toFixed(0));
          if(!hasOffered){
            hasOffered=true;
            await loadIceServers();
            await startWebRTC();
            monitorStats();
          }
          break;
        case "answer":
          console.log("üîÑ answer @",performance.now().toFixed(0),pc.signalingState);
          await pc.setRemoteDescription({type:"answer",sdp:msg.sdp});
          break;
        case "ice":
          console.log("üíß ICE from server:",msg.candidate);
          await pc.addIceCandidate(msg.candidate);
          break;
        case "chat":
          document.getElementById("chatLog")
            .insertAdjacentHTML("beforeend",`<div><b>${msg.from}:</b> ${msg.text}</div>`);
          break;
        case "material_event":
          handleMaterial(msg.event,msg.payload);
          break;
      }
    };

    async function startWebRTC(){
      localStream = await navigator.mediaDevices.getUserMedia({audio:true});
      pc = new RTCPeerConnection({iceServers:ICE_SERVERS,iceTransportPolicy:"relay"});
      console.log("üõ† PC created @",performance.now().toFixed(0));

      pc.onicecandidate = e=>{
        if(e.candidate){
          ws.send(JSON.stringify({type:"ice",candidate:e.candidate.toJSON()}));
        }
      };
      pc.oniceconnectionstatechange = ()=>console.log("üåê ICE state:",pc.iceConnectionState);
      pc.onconnectionstatechange    = ()=>console.log("üîó Conn state:",pc.connectionState);

      pc.ontrack = e=>{
        console.log("üîä ontrack @",performance.now().toFixed(0));
        let audio=document.createElement("audio");
        audio.srcObject=e.streams[0]; audio.autoplay=true;
        audio.onplaying=()=>console.log("‚ñ∂Ô∏è onplaying @",performance.now().toFixed(0));
        document.body.appendChild(audio);
      };

      localStream.getTracks().forEach(t=>{
        pc.addTrack(t,localStream);
        console.log("‚ûï Added track:",t.kind);
      });

      pc.onnegotiationneeded = async ()=>{
        console.log("‚úàÔ∏è negotiationneeded @",performance.now().toFixed(0));
        await pc.setLocalDescription(await pc.createOffer());
        ws.send(JSON.stringify({type:"offer",sdp:pc.localDescription.sdp}));
      };
    }

    function monitorStats(){
      setInterval(async()=>{
        if(!pc)return;
        let stats=await pc.getStats(),out="",now=performance.now().toFixed(0);
        stats.forEach(r=>{
          if(r.type==="inbound-rtp"&&r.kind==="audio"){
            let rtt=(r.roundTripTime||r.currentRoundTripTime||0).toFixed(3),
                jb=(r.jitterBufferDelay||0).toFixed(3),
                em=r.jitterBufferEmittedCount||0;
            out+=`‚è± RTT:${rtt}s  jBufDelay:${jb}s  emitCount:${em}\n`;
          }
          if(r.type==="candidate-pair"&&r.state==="succeeded"){
            out+=`üîÑ cand-pair RTT:${(r.currentRoundTripTime||0).toFixed(3)}s\n`;
          }
        });
        document.getElementById("stats").textContent=`@${now}ms\n`+out;
      },3000);
    }

    document.getElementById("sendBtn").onclick=()=>{
      let txt=document.getElementById("msgIn").value;
      ws.send(JSON.stringify({type:"chat",from:tokenRole(),text:txt}));
    };
    document.getElementById("admitBtn").onclick=()=>{
      let pid=+document.getElementById("waitingList").value;
      ws.send(JSON.stringify({type:"admit",peer_id:pid}));
    };
    document.getElementById("nextSlide").onclick=()=>
      ws.send(JSON.stringify({type:"material_event",event:"next_slide"}));
    document.getElementById("startQuiz").onclick=()=>
      ws.send(JSON.stringify({type:"material_event",event:"start_quiz",payload:{quizId:42}}));

    function tokenRole(){
      try{return JSON.parse(atob(token.split(".")[1])).role;}
      catch{return"user";}
    }
    function handleMaterial(evt,p){
      const mat=document.getElementById("material");
      if(evt==="next_slide") mat.innerHTML+="<p>‚û°Ô∏è Next slide</p>";
      if(evt==="start_quiz") mat.innerHTML+=`<p>‚ùì Quiz ${p.quizId}</p>`;
    }
  </script>
</body>
</html>
